<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:tx="http://www.springframework.org/schema/tx" 
       xmlns:context="http://www.springframework.org/schema/context" 
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
                           http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx.xsd 
                           http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd
">


    <tx:annotation-driven transaction-manager="jpaTransactionManager" />
    
    <context:component-scan base-package="com.github.nexus" />
    

    <!-- Resources -->
    <bean class="com.github.nexus.api.VersionResource"/>
    <bean class="com.github.nexus.api.UpCheckResource"/>
    <bean class="com.github.nexus.api.TransactionResource">
        <constructor-arg ref="enclave"/>
        <constructor-arg>
            <bean class="com.github.nexus.util.Base64Decoder" factory-method="create" />
        </constructor-arg>
    </bean>
    <bean class="com.github.nexus.api.PartyInfoResource">
        <constructor-arg ref="partyInfoService"/>
        <constructor-arg>
            <bean class="com.github.nexus.node.PartyInfoParser" factory-method="create"/>
        </constructor-arg>
    </bean>


    <bean name="partyInfoService" class="com.github.nexus.node.PartyInfoServiceImpl"/>


    <bean name="payloadEncoder" class="com.github.nexus.transaction.PayloadEncoderImpl" />

    <bean name="enclave" class="com.github.nexus.enclave.EnclaveImpl">
        <constructor-arg ref="transactionService" />
    </bean>

    <bean name="transactionService" class="com.github.nexus.transaction.TransactionServiceImpl">
        <constructor-arg ref="encryptedTransactionDAO"/>
        <constructor-arg ref="payloadEncoder" />
        <constructor-arg ref="keyManager" />
        <constructor-arg ref="nacl" />
    </bean>

    <bean id="configHolder" class="com.github.nexus.config.ConfigHolder" factory-method="getInstance" />

    <bean name="keyManager" class="com.github.nexus.enclave.keys.KeyManagerImpl">
        <constructor-arg value="./" />
        <constructor-arg ref="nacl" />
        <constructor-arg>
          <bean factory-bean="configHolder" factory-method="getConfig" />
        </constructor-arg>
    </bean>

    <bean name="nacl" class="com.github.nexus.encryption.Kalium">
        <constructor-arg>
            <bean class="org.abstractj.kalium.NaCl" factory-method="sodium" />
        </constructor-arg>
    </bean>

    <bean name="encryptedTransactionDAO" class="com.github.nexus.transaction.EncryptedTransactionDAOImpl" />
        
    <bean class="com.github.nexus.api.exception.DefaultExceptionMapper" />
    <bean class="com.github.nexus.api.exception.DecodingExceptionMapper"/>
    
    <bean id="dataSource" class="org.h2.jdbcx.JdbcDataSource">
        <property name="url" value="jdbc:h2:./target/h2/nexus;MODE=Oracle;TRACE_LEVEL_SYSTEM_OUT=0" />
        <property name="user" value="sa" />
        <property name="password" value="" />
    </bean>
    

    <bean id="jpaTransactionManager" class="org.springframework.orm.jpa.JpaTransactionManager">
        <property name="entityManagerFactory" ref="entityManagerFactory" />
    </bean>
    
    <bean id="entityManagerFactory" class="org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean">


        <property name="dataSource" ref="dataSource" />
        <property name="persistenceUnitName" value="nexus" />

        <property name="jpaVendorAdapter">
            <bean class="org.springframework.orm.jpa.vendor.EclipseLinkJpaVendorAdapter">
                <property name="databasePlatform" value="org.eclipse.persistence.platform.database.H2Platform"/>
            </bean>
        </property>
        <property name="jpaDialect">
            <bean class="org.springframework.orm.jpa.vendor.EclipseLinkJpaDialect" />
        </property>  
        
        <property name="jpaPropertyMap">
            <props>
                <prop key="eclipselink.weaving">false</prop>
                <prop key="eclipselink.session-name">nexus</prop>
<!--                <prop key="eclipselink.logging.level">FINE</prop>-->
                <prop key="eclipselink.logging.logger">org.eclipse.persistence.logging.slf4j.SLF4JLogger</prop>                
                <prop key="eclipselink.logging.session">false</prop>

                <prop key="javax.persistence.schema-generation.database.action">create</prop>
                <prop key="javax.persistence.schema-generation.scripts.action">none</prop>

            </props>
        </property>         

    </bean>
    
</beans>
